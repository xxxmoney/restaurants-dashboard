<!DOCTYPE html>
<html>

<head>
    <title>Restaurants</title>
    <meta http-equiv="Content-Security-Policy" content="">

    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" type="text/css" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script src="https://unpkg.com/@vueuse/shared"></script>
    <script src="https://unpkg.com/@vueuse/core"></script>

    <style>
        html, body, #app {
            width: 100%;
            height: 100%;
            margin: 0;
        }
        html {
            height: 100vh;
        }
        * {
            box-sizing: border-box;
        }
    </style>
</head>

<body>
<div id="app" class="py-2 px-1 lg:p-4">
    <div class="w-full h-full flex flex-col gap-4">
        <div class="flex-0 text-center my-2">
            <div id="header" class="relative flex flex-row justify-center items-center gap-8">
                <h1 class="text-2xl text-white z-10">Restaurace v okolí</h1>

                <div class="tooltip hidden lg:flex flex-row justify-center z-10" data-tip="Carousel">
                    <input type="checkbox" class="toggle" v-model="enableCarousel" />
                </div>
            </div>
        </div>

        <div class="flex-1 carousel" :class="{ 'lg:grid lg:grid-cols-4': !enableCarousel }">
            <template v-for="(restaurant, index) in restaurants">
                <div :id="`slide_${index}`" class="relative w-full max-lg:relative carousel-item" ref="carouselItemsRef">
                    <template v-if="restaurant.handler">
                        <div v-if="!restaurant.content" class="w-full h-full flex flex-row justify-center items-center font-bold">LOADING</div>
                        <iframe v-else :srcdoc="restaurant.content" class="w-full h-full border-none" :style="{ zoom: restaurant.zoom }"></iframe>
                    </template>
                    <template v-else>
                        <iframe :src="restaurant.url" class="w-full h-full border-none" :style="{ zoom: restaurant.zoom }" referrerpolicy="unsafe-url"></iframe>
                    </template>

                    <Teleport v-if="isMobile || currentIndex === index" defer to="#header" :disabled="isMobile || !enableCarousel">
                        <div class="absolute left-2 right-2 top-1/2 flex -translate-y-1/2 transform justify-between lg:left-5 lg:right-5" :class="{ 'lg:hidden': isMobile || !enableCarousel }">
                            <a :href="`#slide_${getPreviousIndex(index)}`" @click="setPreviousIndex(index)" class="btn btn-lg btn-circle lg:btn-sm">❮</a>
                            <a :href="`#slide_${getNextIndex(index)}`" @click="setNextIndex(index)" class="btn btn-lg btn-circle lg:btn-sm">❯</a>
                        </div>
                    </Teleport>
                </div>
            </template>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue
    const { breakpointsTailwind, useBreakpoints, useElementVisibility, useStorage } = VueUse

    createApp({
        setup() {
            const proxyUrl = 'https://proxy-worker.xxxmoney111.workers.dev/?';

            const carouselItemsRef = ref(null);
            const enableCarousel = useStorage('enable-carousel', true);
            const restaurants = ref([
                {
                    url: 'https://www.restaurace-u-sisku.cz',
                    zoom: 1.25
                },
                {
                    url: 'https://www.restauraceklika.cz',
                    zoom: 1
                },
                {
                    url: 'http://www.restaurantbarredhook.cz/?Polední_menu',
                    handler: (url) => {
                        return getUrlContent(url)
                    },
                    zoom: 1
                },
                {
                    url: 'https://nominanza.com/index-pankrac.html#mu-reservation',
                    zoom: 0.75
                },
            ])
            const breakpoints = useBreakpoints(breakpointsTailwind);
            const isMobile = computed(() => breakpoints.isSmaller('lg'));

            const getUrlContent = async (url) => {
                const response = await fetch(proxyUrl + url);
                return await response.text();
            }

            const currentIndex = ref(0);
            const getNextIndex = (index) => {
                return (index + 1) % restaurants.value.length;
            }
            const setNextIndex = (index) => {
                currentIndex.value = getNextIndex(index);
            }
            const getPreviousIndex = (index) => {
                return (index - 1 + restaurants.value.length) % restaurants.value.length;
            }
            const setPreviousIndex = (index) => {
                currentIndex.value = getPreviousIndex(index);
            }

            // Watch isMobile to refresh index
            watch(isMobile, () => {
                currentIndex.value = 0;
            })

            onMounted(async () => {
                // Run handlers for restaurants that have them
                for (const restaurant of restaurants.value.filter(restaurant => restaurant.handler)) {
                    try {
                        restaurant.content = await restaurant.handler(restaurant.url)
                    } catch (e) {
                        console.error(e)
                    }
                }
            })

            return {
                carouselItemsRef,
                isMobile,
                enableCarousel,
                restaurants,
                currentIndex,
                setNextIndex,
                setPreviousIndex,
                getNextIndex,
                getPreviousIndex
            }
        }
    }).mount('#app')
</script>
</body>

</html>